<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Google Protobuf Deserializer</title>
  <link href="./common.css" rel="stylesheet">
  <link href="./main.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>

    var proto_list = [];

    function equal(buf1, buf2) {
        if (buf1.byteLength != buf2.byteLength) return false;
        var dv1 = new Int8Array(buf1);
        var dv2 = new Int8Array(buf2);
        for (var i = 0; i != buf1.byteLength; i++) {
          if (dv1[i] != dv2[i]) return false;
        }
        return true;
    }

    function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      $('#output')[0].innerText = "";

      var files = evt.dataTransfer.files; // FileList object.
      var output = [];
      for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();
        reader.onload = (function (theFile) {
          return function (e) {
            var select_proto = $("#proto-list-select")[0].value;
            if(select_proto === 'auto-detect'){
              Object.entries(ConstructorsDict).forEach(([key, value]) => {
                try {
                  console.log(btoa(e.target.result));
                  var base64_data = btoa(e.target.result);
                  var message = new ConstructorsDict[key].deserializeBinary(base64_data);
                  var message2base64 = btoa(
                    new Uint8Array(message.serializeBinary())
                      .reduce((data, byte) => data + String.fromCharCode(byte), '')
                  );

                  if (base64_data == message2base64) {
                    $('#output')[0].innerText += key + ":\n" + JSON.stringify(message.toObject(), null, 4) + "\n\n";
                    return true;
                  }
                  else {
                    console.log("verify " + key + "wrong, try another.");
                    return false;
                  }
                }
                catch (e) {
                  console.log("exception:", e, "\n try another constructor");
                  return false;
                }
              });
            }else{
              console.log(e.target.result);
              var message = new ConstructorsDict["proto.Line"].deserializeBinary(btoa(e.target.result));
              $('#output')[0].innerText += JSON.stringify(message.toObject(), null, 4) + "\n";
            }
          };
        })(f);

        reader.readAsBinaryString(f);
      }
    }

    function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    function saveByteArray(reportName, byte) {
      var blob = new Blob([byte], { type: "text/plain" });
      var link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      var fileName = reportName;
      link.download = fileName;
      link.click();
    };

    $(document).ready(function () {
	  
      // Setup the dnd listeners.
      // var dropZone = document.getElementById('drop_zone');
      var dropZone = document.getElementById('container');
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileSelect, false);
	  
      jQuery.ajax({
        url: '997dddf3-f972-42c6-b3e8-3af7517c968d.js',
        dataType: 'script',
        success: function () {
          console.log('done');
        },
        async: true
      });

	    $('#output')[0].innerText = "ccc";
    });

  </script>
</head>

<body>
  <div class="wrapper">
    <div class="kanban">
      <div class="title">
        <div class="title1">Google Protobuf</div>
        <div class="title2">Deserializer</div>
      </div>
      <div class="note">
        Support to deserialize the protobuf data to pretty json display. (Note: your .proto file will be send to backend server to
        generate proto.js library, and then the browser will use this proto.js library to deserialize your pb data, your pb data will
        not be send to backend server)
      </div>
    </div>
    <div class="prepare-data">
      <div class="step step1">
        <div class="description">Step1: Upload your proto files, and then click Generate button.</div>
        <div class="upload-panel">
          <div class="drop-zone" id="drop-proto">
            <div class="upload-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 48 48">
              <path style="fill: gold;"
                d="M38.71 20.07C37.35 13.19 31.28 8 24 8c-5.78 0-10.79 3.28-13.3 8.07C4.69 16.72 0 21.81 0 28c0 6.63 5.37 12 12 12h26c5.52 0 10-4.48 10-10 0-5.28-4.11-9.56-9.29-9.93zM28 26v8h-8v-8h-6l10-10 10 10h-6z" />
              </svg>
            </div>
            <div class="drag-description">Drag your .proto files here.</div>
            <div class="upload-file-icon" id="proto-icon">0</div>
          </div>
          <div class="ctrl-pannel">
            <button id="upload-proto-button" type="button" class="click-btn-v2">Upload</button>
            <button id="clear-proto-button" type="button" class="click-btn-v2">Clear</button>
            <button id="Generate-protojs-button" type="button" class="click-btn-v2 last-button">Generate</button>
          </div>
        </div>
      </div>
      <div class="step step2">
        <div class="description">Step2: Upload your pd data, and then click Deserialize button.</div>
        <div class="upload-panel">
          <div class="drop-zone" id="drop-proto">
            <div class="upload-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 48 48">
                <path style="fill: gold;"
                  d="M38.71 20.07C37.35 13.19 31.28 8 24 8c-5.78 0-10.79 3.28-13.3 8.07C4.69 16.72 0 21.81 0 28c0 6.63 5.37 12 12 12h26c5.52 0 10-4.48 10-10 0-5.28-4.11-9.56-9.29-9.93zM28 26v8h-8v-8h-6l10-10 10 10h-6z" />
              </svg>
            </div>
            <div class="drag-description">Drag your pd data files here.</div>
            <div class="upload-file-icon" id="proto-icon">0</div>
          </div>
          <div class="ctrl-pannel">
            <button id="upload-proto-button" type="button" class="click-btn-v2">Upload</button>
            <button id="clear-proto-button" type="button" class="click-btn-v2">Clear</button>
            <button id="Generate-protojs-button" type="button" class="click-btn-v2 last-button">Deserialize</button>
          </div>
        </div>
      </div>
    </div>
    <div class="status">
      <div class="status-data"><span class="status-title">Step1:</span><span class="status-content" id="step1-status">No proto file</span></div>
      <div class="status-data"><span class="status-title">Step2:</span><span class="status-content" id="step2-status">No proto data file</span></div>
    </div>
    <div class="display-page">
      <div class="display-title">Deserialize Result:</div>
      <button id="download-output-button" type="button" class="click-btn-v2 last-button">Download</button>
      <button id="clear-output-button" type="button" class="click-btn-v2 last-button">Clear</button>
      <div class="display-output">CCC</div>
    </div>
    <div class="footer-page">
      <div class="relate-links">
        <div class="relate-links-title">Relate Links:</div>
        <a class="relate-link" target="_blank" href="https://github.com/zmcx16/protobuf-deserializer/">protobuf-deserializer Github</a>
        <a class="relate-link" target="_blank" href="https://project.zmcx16.moe/">zmcx16's Side Projects</a>
        <a class="relate-link" target="_blank" href="https://blog.zmcx16.moe/">zmcx16's Blog</a>
      </div>
      <div class="copyright"><span class="copyright-icon">Â©</span>zmcx16 All rights reserved.</div>
    </div>
  </div>

  <div id="container" style="display:none;">
    <select id="proto-list-select">
    </select>
    <div id="drop_zone">Drop files anywhere</div>
    <div id="output"></div>
    <a href="" id="a">click here to download your file</a>
  </div>
</body>

</html>