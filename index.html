<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="./main.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>

    var proto_list = [];

    function equal(buf1, buf2) {
        if (buf1.byteLength != buf2.byteLength) return false;
        var dv1 = new Int8Array(buf1);
        var dv2 = new Int8Array(buf2);
        for (var i = 0; i != buf1.byteLength; i++) {
          if (dv1[i] != dv2[i]) return false;
        }
        return true;
    }

    function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      $('#output')[0].innerText = "";

      var files = evt.dataTransfer.files; // FileList object.
      var output = [];
      for (var i = 0, f; f = files[i]; i++) {
        var reader = new FileReader();
        reader.onload = (function (theFile) {
          return function (e) {
            var select_proto = $("#proto-list-select")[0].value;
            if(select_proto === 'auto-detect'){
              Object.entries(ConstructorsDict).forEach(([key, value]) => {
                try {
                  console.log(btoa(e.target.result));
                  var base64_data = btoa(e.target.result);
                  var message = new ConstructorsDict[key].deserializeBinary(base64_data);
                  var message2base64 = btoa(
                    new Uint8Array(message.serializeBinary())
                      .reduce((data, byte) => data + String.fromCharCode(byte), '')
                  );

                  if (base64_data == message2base64) {
                    $('#output')[0].innerText += key + ":\n" + JSON.stringify(message.toObject(), null, 4) + "\n\n";
                    return true;
                  }
                  else {
                    console.log("verify " + key + "wrong, try another.");
                    return false;
                  }
                }
                catch (e) {
                  console.log("exception:", e, "\n try another constructor");
                  return false;
                }
              });
            }else{
              console.log(e.target.result);
              var message = new ConstructorsDict["proto.Line"].deserializeBinary(btoa(e.target.result));
              $('#output')[0].innerText += JSON.stringify(message.toObject(), null, 4) + "\n";
            }
          };
        })(f);

        reader.readAsBinaryString(f);
      }
    }

    function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    function saveByteArray(reportName, byte) {
      var blob = new Blob([byte], { type: "text/plain" });
      var link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      var fileName = reportName;
      link.download = fileName;
      link.click();
    };

    $(document).ready(function () {
	  
      // Setup the dnd listeners.
      // var dropZone = document.getElementById('drop_zone');
      var dropZone = document.getElementById('container');
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileSelect, false);
	  
      jQuery.ajax({
        url: '997dddf3-f972-42c6-b3e8-3af7517c968d.js',
        dataType: 'script',
        success: function () {
          console.log('done');
        },
        async: true
      });

	    $('#output')[0].innerText = "ccc";
    });

  </script>
</head>

<body>
  <div class="wrapper">
    <div class="kanban">
      <div class="title">
        Google Protobuf Deserializer
      </div>
      <div class="note">
        Support to deserialize the protobuf data to pretty json display (Note: your .proto file will be send to backend server to
        generate proto.js library, and then the front end will use this proto.js library to deserialize your pb data, your pb data will
        not be send to backend serve.)
      </div>
    </div>
    <div class="prepare-data">
      prepare-page
    </div>
    <div class="status">
      status-page
    </div>
    <div class="display-page">
      deserialize-btn, download-btn, display text
    </div>
    <div class="footer-page">
      <div class="relate-links">
      </div>
      <div class="copyright">
      </div>
    </div>
  </div>
  <div id="container">
    <select id="proto-list-select">
    </select>
    <div id="drop_zone">Drop files anywhere</div>
    <div id="output"></div>
    <a href="" id="a">click here to download your file</a>
  </div>
</body>

</html>